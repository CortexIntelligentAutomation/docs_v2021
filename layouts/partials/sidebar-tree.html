{{/* We cache this partial for bigger sites and set the active class client side. */}}
{{ $shouldDelayActive := ge (len .Site.Pages) 2000 }}
<div id="td-sidebar-menu" class="td-sidebar__inner{{ if $shouldDelayActive }} d-none{{ end }}">
  {{ if not .Site.Params.ui.sidebar_search_disable }}
  <form class="td-sidebar__search d-flex align-items-center">
    {{ partial "search-input.html" . }}
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  {{ else }}
  <div id="content-mobile">
  <form class="td-sidebar__search d-flex align-items-center">
    {{ partial "search-input.html" . }}
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  </div>
  <div id="content-desktop"></div>
  {{ end }}
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    {{ if  (gt (len .Site.Home.Translations) 0) }}
    <div class="nav-item dropdown d-block d-lg-none">
      {{ partial "navbar-lang-selector.html" . }}
    </div>
    {{ end }}
    {{ $navRoot := cond (and (ne .Params.toc_root true) (eq .Site.Home.Type "docs")) .Site.Home .FirstSection }}
    {{ $ulNr := 0 -}}
    {{ $ulShow := cond (isset .Site.Params.ui "ul_show") .Site.Params.ui.ul_show 1 -}}
    <ul class="td-sidebar-nav__section pr-md-3  ul-{{ $ulNr }}">
      {{ template "section-tree-nav-section" (dict "page" . "section" $navRoot "delayActive" $shouldDelayActive "ulNr" $ulNr "ulShow" (add $ulShow 1)) }}
    </ul>
  </nav>
</div>
{{ define "section-tree-nav-section" }}
  {{ $ulNr := .ulNr -}}
  {{ $s := .section }}
  {{ $p := .page }}
  {{ $ulShow := .ulShow -}}
  {{ $shouldDelayActive := .delayActive }}
  {{ $active := eq $p.CurrentSection $s }}
  {{ $activePath := and (not $shouldDelayActive) (or (eq $p $s) ($p.IsDescendant $s)) -}}
  {{ $hidden := and (not $activePath) (eq $ulNr 1) -}}
  {{ $activePath := and (not $shouldDelayActive) (or (eq $p $s) ($p.IsDescendant $s)) -}}
  {{ $show := or (and (not $p.Site.Params.ui.sidebar_menu_compact) ($p.IsAncestor $s)) ($p.IsDescendant $s) }}
  {{ $pages_tmp := where (union $s.Pages $s.Sections).ByWeight ".Params.toc_hide" "!=" true -}}
  {{ $pages := $pages_tmp -}}
  {{ $withChild := gt (len $pages) 0 -}}
  {{ $sid := $s.RelPermalink | anchorize }}
  {{ if not $hidden }}
    {{ if ne $ulNr 1}}
      <li class="td-sidebar-nav__section-title">
        <a  href="{{ $s.RelPermalink }}" class="align-left pl-0 pr-2{{ if not $show }} collapsed{{ end }}{{ if $active}} active{{ end }} td-sidebar-link td-sidebar-link__section">{{ $s.LinkTitle }}</a>
      </li>
      <ul>
        <li class="collapse {{ if $show }}show{{ end }}" id="{{ $sid }}">
          {{ $pages := where (union $s.Pages $s.Sections).ByWeight ".Params.toc_hide" "!=" true }}
          {{ $pages := $pages | first 50 }}
          {{ range $pages }}
          {{ if (not (and (eq $s $p.Site.Home) (eq .Params.toc_root true))) }}
            {{ if .IsPage }}
              {{ $mid := printf "m-%s" (.RelPermalink | anchorize) }}
              {{ $active := eq . $p }}
              <a class="td-sidebar-link td-sidebar-link__page {{ if and (not $shouldDelayActive) $active }} active{{ end }}" id="{{ $mid }}" href="{{ .RelPermalink }}">{{ .LinkTitle }}</a>
            {{ else }}
              {{- $ulNr := add $ulNr 1 }}
              <ul class="td-sidebar-nav__section pr-md-3  ul-{{ $ulNr }}">
                {{ template "section-tree-nav-section" (dict "page" $p "section" . "ulNr" $ulNr) }}
              </ul>
            {{ end }}
          {{ end }}
          {{ end }}
        </li>
      </ul>
    {{ else }}
      {{- if $withChild }}
        {{- $ulNr := add $ulNr 1 }}
        {{ range $pages -}}
        {{ if (not (and (eq $s $p.Site.Home) (eq .Params.toc_root true))) -}}
        {{ template "section-tree-nav-section" (dict "page" $p "section" . "shouldDelayActive" $shouldDelayActive "ulNr" $ulNr "ulShow" $ulShow) }}
        {{- end }}
        {{- end }}
      {{- end }}
    {{ end }}
  {{ end }}
{{ end }}
